<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-button (click)="goBack()">
        <ion-icon slot="icon-only" name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Profil & Tetapan</ion-title>
    <ion-buttons slot="end">
      <ion-button *ngIf="!editMode" (click)="toggleEditMode()">
        <ion-icon slot="icon-only" name="create-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">

  <!-- Loading State -->
  <div class="loading-container" *ngIf="loading">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Memuatkan profil...</p>
  </div>

  <div class="content-wrapper" *ngIf="!loading">

    <!-- Profile Header -->
    <div class="profile-header">
      <div class="avatar-container">
        <div class="default-avatar">
          {{getInitials()}}
        </div>
      </div>

      <div class="user-info" *ngIf="!editMode">
        <h1>{{user.name}}</h1>
        <p>{{user.email}}</p>
        <ion-badge color="primary">
          Ahli sejak {{formatMemberSince(user.memberSince)}}
        </ion-badge>
      </div>

      <!-- Edit Mode -->
      <div class="edit-info" *ngIf="editMode">
        <ion-item>
          <ion-label position="stacked">Nama Penuh</ion-label>
          <ion-input [(ngModel)]="editedUser.name" type="text"></ion-input>
        </ion-item>
        <ion-item>
          <ion-label position="stacked">Email</ion-label>
          <ion-input [(ngModel)]="editedUser.email" type="email"></ion-input>
        </ion-item>
        <ion-item>
          <ion-label position="stacked">No. Telefon</ion-label>
          <ion-input [(ngModel)]="editedUser.phone" type="tel"></ion-input>
        </ion-item>

        <div class="edit-actions">
          <ion-button expand="block" (click)="saveProfile()">
            <ion-icon slot="start" name="checkmark"></ion-icon>
            Simpan
          </ion-button>
          <ion-button expand="block" fill="outline" (click)="toggleEditMode()">
            Batal
          </ion-button>
        </div>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-section" *ngIf="!editMode">
      <h3>Statistik Anda</h3>
      <div class="stats-grid">
        <ion-card class="stat-card">
          <ion-card-content>
            <div class="stat-icon">
              <ion-icon name="calendar"></ion-icon>
            </div>
            <h2>{{stats.totalAppointments}}</h2>
            <p>Jumlah Temujanji</p>
          </ion-card-content>
        </ion-card>

        <ion-card class="stat-card">
          <ion-card-content>
            <div class="stat-icon success">
              <ion-icon name="checkmark-circle"></ion-icon>
            </div>
            <h2>{{stats.completedAppointments}}</h2>
            <p>Selesai</p>
          </ion-card-content>
        </ion-card>

        <ion-card class="stat-card">
          <ion-card-content>
            <div class="stat-icon warning">
              <ion-icon name="people"></ion-icon>
            </div>
            <h2>{{stats.totalQueues}}</h2>
            <p>Giliran Dijana</p>
          </ion-card-content>
        </ion-card>

        <ion-card class="stat-card">
          <ion-card-content>
            <div class="stat-icon primary">
              <ion-icon name="time"></ion-icon>
            </div>
            <h2>{{stats.averageWaitTime}} min</h2>
            <p>Purata Tunggu</p>
          </ion-card-content>
        </ion-card>
      </div>
    </div>

    <!-- Settings Sections -->
    <div class="settings-sections" *ngIf="!editMode">

      <!-- Personal Info -->
      <div class="section">
        <h3>Maklumat Peribadi</h3>
        <ion-list>
          <ion-item>
            <ion-icon name="person-outline" slot="start"></ion-icon>
            <ion-label>
              <p>Nama</p>
              <h2>{{user.name}}</h2>
            </ion-label>
          </ion-item>
          <ion-item>
            <ion-icon name="mail-outline" slot="start"></ion-icon>
            <ion-label>
              <p>Email</p>
              <h2>{{user.email}}</h2>
            </ion-label>
          </ion-item>
          <ion-item>
            <ion-icon name="call-outline" slot="start"></ion-icon>
            <ion-label>
              <p>Telefon</p>
              <h2>{{user.phone}}</h2>
            </ion-label>
          </ion-item>
          <ion-item>
            <ion-icon name="card-outline" slot="start"></ion-icon>
            <ion-label>
              <p>No. Kad Pengenalan</p>
              <h2>{{user.icNumber}}</h2>
            </ion-label>
          </ion-item>
          <ion-item>
            <ion-icon name="location-outline" slot="start"></ion-icon>
            <ion-label>
              <p>Alamat</p>
              <h2>{{user.address}}</h2>
            </ion-label>
          </ion-item>
        </ion-list>
      </div>

      <!-- Notifications -->
      <div class="section">
        <h3>Notifikasi</h3>
        <ion-list>
          <ion-item>
            <ion-icon name="notifications-outline" slot="start"></ion-icon>
            <ion-label>
              <h2>Amaran Giliran</h2>
              <p>Terima notifikasi bila giliran hampir tiba</p>
            </ion-label>
            <ion-toggle [checked]="settings.notifications.queueAlerts"
              (ionChange)="toggleNotificationSetting('queueAlerts')" slot="end"></ion-toggle>
          </ion-item>

          <ion-item>
            <ion-icon name="calendar-outline" slot="start"></ion-icon>
            <ion-label>
              <h2>Peringatan Temujanji</h2>
              <p>Peringatan sehari sebelum temujanji</p>
            </ion-label>
            <ion-toggle [checked]="settings.notifications.appointmentReminders"
              (ionChange)="toggleNotificationSetting('appointmentReminders')" slot="end"></ion-toggle>
          </ion-item>

          <ion-item>
            <ion-icon name="information-circle-outline" slot="start"></ion-icon>
            <ion-label>
              <h2>Notifikasi Sistem</h2>
              <p>Kemas kini dan pengumuman</p>
            </ion-label>
            <ion-toggle [checked]="settings.notifications.systemNotifications"
              (ionChange)="toggleNotificationSetting('systemNotifications')" slot="end"></ion-toggle>
          </ion-item>

          <ion-item>
            <ion-icon name="mail-outline" slot="start"></ion-icon>
            <ion-label>
              <h2>Email Notifikasi</h2>
              <p>Terima notifikasi melalui email</p>
            </ion-label>
            <ion-toggle [checked]="settings.notifications.emailNotifications"
              (ionChange)="toggleNotificationSetting('emailNotifications')" slot="end"></ion-toggle>
          </ion-item>
        </ion-list>
      </div>

      <!-- Preferences -->
      <div class="section">
        <h3>Keutamaan</h3>
        <ion-list>
          <ion-item>
            <ion-icon name="language-outline" slot="start"></ion-icon>
            <ion-label>
              <h2>Bahasa</h2>
              <p>Bahasa Melayu</p>
            </ion-label>
          </ion-item>

          <ion-item>
            <ion-icon name="moon-outline" slot="start"></ion-icon>
            <ion-label>
              <h2>Mod Gelap</h2>
              <p>Tema gelap untuk mata</p>
            </ion-label>
            <ion-toggle [checked]="settings.preferences.darkMode" (ionChange)="togglePreferenceSetting('darkMode')"
              slot="end"></ion-toggle>
          </ion-item>

          <ion-item>
            <ion-icon name="navigate-outline" slot="start"></ion-icon>
            <ion-label>
              <h2>Perkhidmatan Lokasi</h2>
              <p>Untuk mencari klinik berhampiran</p>
            </ion-label>
            <ion-toggle [checked]="settings.preferences.locationServices"
              (ionChange)="togglePreferenceSetting('locationServices')" slot="end"></ion-toggle>
          </ion-item>
        </ion-list>
      </div>

      <!-- Privacy & Security -->
      <div class="section">
        <h3>Privasi & Keselamatan</h3>
        <ion-list>
          <ion-item button (click)="changePassword()">
            <ion-icon name="lock-closed-outline" slot="start"></ion-icon>
            <ion-label>
              <h2>Tukar Kata Laluan</h2>
            </ion-label>
            <ion-icon name="chevron-forward" slot="end"></ion-icon>
          </ion-item>

          <ion-item>
            <ion-icon name="shield-outline" slot="start"></ion-icon>
            <ion-label>
              <h2>Kongsi Data Kesihatan</h2>
              <p>Untuk penambahbaikan perkhidmatan</p>
            </ion-label>
            <ion-toggle [checked]="settings.privacy.shareHealthData"
              (ionChange)="togglePrivacySetting('shareHealthData')" slot="end"></ion-toggle>
          </ion-item>

          <ion-item>
            <ion-icon name="analytics-outline" slot="start"></ion-icon>
            <ion-label>
              <h2>Analitik</h2>
              <p>Bantu kami tingkatkan aplikasi</p>
            </ion-label>
            <ion-toggle [checked]="settings.privacy.allowAnalytics" (ionChange)="togglePrivacySetting('allowAnalytics')"
              slot="end"></ion-toggle>
          </ion-item>
        </ion-list>
      </div>

      <!-- Support & About -->
      <div class="section">
        <h3>Sokongan & Maklumat</h3>
        <ion-list>
          <ion-item button>
            <ion-icon name="help-circle-outline" slot="start"></ion-icon>
            <ion-label>
              <h2>Pusat Bantuan</h2>
            </ion-label>
            <ion-icon name="chevron-forward" slot="end"></ion-icon>
          </ion-item>

          <ion-item button>
            <ion-icon name="document-text-outline" slot="start"></ion-icon>
            <ion-label>
              <h2>Syarat & Terma</h2>
            </ion-label>
            <ion-icon name="chevron-forward" slot="end"></ion-icon>
          </ion-item>

          <ion-item button>
            <ion-icon name="shield-checkmark-outline" slot="start"></ion-icon>
            <ion-label>
              <h2>Dasar Privasi</h2>
            </ion-label>
            <ion-icon name="chevron-forward" slot="end"></ion-icon>
          </ion-item>

          <ion-item>
            <ion-icon name="information-outline" slot="start"></ion-icon>
            <ion-label>
              <h2>Versi Aplikasi</h2>
              <p>v1.0.0</p>
            </ion-label>
          </ion-item>
        </ion-list>
      </div>

      <!-- Account Actions -->
      <div class="section">
        <ion-list>
          <ion-item button (click)="logout()">
            <ion-icon name="log-out-outline" slot="start" color="medium"></ion-icon>
            <ion-label color="medium">
              <h2>Log Keluar</h2>
            </ion-label>
          </ion-item>

          <ion-item button (click)="deleteAccount()">
            <ion-icon name="trash-outline" slot="start" color="danger"></ion-icon>
            <ion-label color="danger">
              <h2>Padam Akaun</h2>
            </ion-label>
          </ion-item>
        </ion-list>
      </div>

    </div>

  </div>

</ion-content>