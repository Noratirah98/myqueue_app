<ion-header [translucent]="true" class="modern-header">
  <ion-toolbar>
    <ion-title class="center-title">
      <div class="header-title-content">
        <span>MyQueue</span>
      </div>
    </ion-title>

    <ion-buttons slot="end" class="header-actions">
      <ion-button color="light" (click)="viewNotifications()">
        <ion-icon slot="icon-only" name="notifications-outline"></ion-icon>
        <ion-badge *ngIf="unreadNotifications > 0" color="danger" class="notification-badge">
          <span>{{ unreadNotifications }}</span>
        </ion-badge>
      </ion-button>

      <ion-button color="light" (click)="logout()">
        <ion-icon slot="icon-only" name="log-out-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="modern-content">
  <div class="content-wrapper">

    <!-- Greeting Section -->
    <div class="greeting-section">
      <div class="greeting-card-gradient">
        <div class="greeting-content">
          <h4 class="greeting-title">
            <span class="wave-emoji">üëã</span>
            <span>Hi, {{ userName }}</span>
          </h4>
          <p class="greeting-subtitle">Welcome to MyQueue</p>
        </div>
        <div class="greeting-decoration">
          <ion-icon name="medical-outline"></ion-icon>
        </div>
      </div>
    </div>

    <!-- ============================================ STATE A: NO ACTIVE QUEUE ============================================ -->
    <div *ngIf="!hasActiveQueue">

      <!-- Quick Action: Book Appointment -->
      <div class="quick-book-section">
        <ion-card class="action-card primary-action" (click)="bookAppointment()">
          <div class="card-glow"></div>
          <ion-card-content>
            <div class="card-icon-wrapper">
              <ion-icon name="calendar-outline"></ion-icon>
            </div>
            <div class="card-text">
              <h2>Book Appointment</h2>
              <p>Schedule your clinic visit</p>
            </div>
            <div class="card-arrow">
              <ion-icon name="arrow-forward-outline"></ion-icon>
            </div>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- ============================================ APPOINTMENT JOURNEY CARDS ============================================ -->

      <!-- Loading State -->
      <div *ngIf="loadingAppointment" class="appointment-loading">
        <ion-spinner name="crescent" color="primary"></ion-spinner>
        <p>Loading your appointments...</p>
      </div>

      <!-- Case 1: TODAY'S APPOINTMENT - NOT CHECKED IN -->
      <div
        *ngIf="!loadingAppointment && nextAppointment && isToday(nextAppointment.date) && !isCheckedIn(nextAppointment)">
        <div class="section-header">
          <div class="section-title">
            <ion-icon name="alert-circle" color="danger"></ion-icon>
            <h3>Action Required</h3>
          </div>
          <ion-button fill="clear" size="small" class="view-all-btn" (click)="viewAppointments()">
            View All
            <ion-icon name="chevron-forward-outline" slot="end"></ion-icon>
          </ion-button>
        </div>

        <ion-card class="urgent-appointment-card">
          <div class="urgent-badge">
            <ion-icon name="alarm"></ion-icon>
            <span>TODAY'S APPOINTMENT</span>
          </div>

          <ion-card-content>
            <div class="appointment-main-info">
              <!-- <div class="clinic-icon-large">
                {{ getClinicIcon(nextAppointment.appointmentType) }}
              </div> -->
              <div class="appointment-details-large">
                <h2>{{ nextAppointment.appointmentType }}</h2>
                <div class="time-info-large">
                  <ion-icon name="time"></ion-icon>
                  <span>{{ nextAppointment.time }}</span>
                </div>
              </div>
            </div>

            <div class="journey-instructions">
              <div class="instruction-title">
                <ion-icon name="information-circle"></ion-icon>
                <span>What to do:</span>
              </div>
              <ol class="instruction-list">
                <li>‚úÖ Appointment confirmed</li>
                <li>üëâ <strong>Arrive at clinic and tap "Check-In"</strong></li>
                <li>üì∑ Scan QR code at counter {{ getCounterLetter(nextAppointment.appointmentType) }}</li>
                <li>üé´ Get your queue number</li>
                <li>‚è∞ Wait for your turn (we'll notify you)</li>
              </ol>
            </div>

            <!-- BIG CHECK-IN BUTTON -->
            <ion-button expand="block" size="large" color="success" class="checkin-btn" (click)="scanQRCode()">
              <ion-icon name="qr-code" slot="start"></ion-icon>
              CHECK-IN NOW
            </ion-button>

            <div class="secondary-actions">
              <ion-button fill="clear" size="small" (click)="viewAppointmentDetails(nextAppointment)">
                <ion-icon name="information-circle" slot="start"></ion-icon>
                View Details
              </ion-button>
              <ion-button fill="clear" size="small" color="danger" (click)="cancelAppointment(nextAppointment)">
                <ion-icon name="close-circle" slot="start"></ion-icon>
                Cancel
              </ion-button>
            </div>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- Case 2: FUTURE APPOINTMENT (Not Today) -->
      <div *ngIf="!loadingAppointment && nextAppointment && !isToday(nextAppointment.date)">
        <div class="section-header">
          <div class="section-title">
            <ion-icon name="calendar"></ion-icon>
            <h3>Upcoming Appointment</h3>
          </div>
          <ion-button fill="clear" size="small" class="view-all-btn" (click)="viewAppointments()">
            View All
            <ion-icon name="chevron-forward-outline" slot="end"></ion-icon>
          </ion-button>
        </div>

        <ion-card class="future-appointment-card">
          <ion-badge class="countdown-badge" [color]="getCountdownColor(nextAppointment.date)">
            {{ getCountdownText(nextAppointment.date) }}
          </ion-badge>

          <ion-card-content>
            <div class="appointment-summary">
              <!-- <div class="clinic-icon-medium">
                {{ getClinicIcon(nextAppointment.appointmentType) }}
              </div> -->
              <div class="appointment-info-medium">
                <h3>{{ nextAppointment.appointmentType }}</h3>
                <div class="date-time-row">
                  <div class="info-item">
                    <ion-icon name="calendar-outline"></ion-icon>
                    <span>{{ formatDate(nextAppointment.date) }}</span>
                  </div>
                  <div class="info-item">
                    <ion-icon name="time-outline"></ion-icon>
                    <span>{{ nextAppointment.time }}</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Journey Progress Steps -->
            <div class="journey-steps">
              <div class="step-title">Your Journey:</div>

              <div class="step completed">
                <div class="step-indicator">
                  <ion-icon name="checkmark-circle"></ion-icon>
                </div>
                <div class="step-content">
                  <div class="step-label">Appointment Booked</div>
                  <div class="step-sublabel">Confirmed</div>
                </div>
              </div>

              <div class="step-connector"></div>

              <div class="step confirmed">
                <div class="step-indicator">
                  <ion-icon name="time"></ion-icon>
                </div>
                <div class="step-content">
                  <div class="step-label">Check-In</div>
                  <div class="step-sublabel">On {{ formatShortDate(nextAppointment.date) }}</div>
                </div>
              </div>

              <div class="step-connector locked"></div>

              <div class="step locked">
                <div class="step-indicator">
                  <ion-icon name="lock-closed"></ion-icon>
                </div>
                <div class="step-content">
                  <div class="step-label">Get Queue Number</div>
                  <div class="step-sublabel">After check-in</div>
                </div>
              </div>

              <div class="step-connector locked"></div>

              <div class="step locked">
                <div class="step-indicator">
                  <ion-icon name="lock-closed"></ion-icon>
                </div>
                <div class="step-content">
                  <div class="step-label">Wait for Turn</div>
                  <div class="step-sublabel">We'll notify you</div>
                </div>
              </div>
            </div>

            <div class="info-note">
              <ion-icon name="information-circle"></ion-icon>
              <p>Arrive 10-15 minutes early. Tap <strong>"Check-In"</strong> button on appointment day to scan QR code.
              </p>
            </div>

            <div class="appointment-actions">
              <ion-button fill="outline" expand="block" (click)="viewAppointmentDetails(nextAppointment)">
                <ion-icon name="eye" slot="start"></ion-icon>
                View Details
              </ion-button>
            </div>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- Case 3: NO APPOINTMENT -->
      <div *ngIf="!loadingAppointment && !nextAppointment" class="no-appointment-section">
        <div class="section-header">
          <div class="section-title">
            <ion-icon name="calendar"></ion-icon>
            <h3>Appointments</h3>
          </div>
          <ion-button fill="clear" size="small" class="view-all-btn" (click)="viewAppointments()">
            View All
            <ion-icon name="chevron-forward-outline" slot="end"></ion-icon>
          </ion-button>
        </div>

        <div class="empty-state">
          <div class="empty-icon-wrapper">
            <ion-icon name="calendar-outline"></ion-icon>
          </div>
          <h3>No Upcoming Appointments</h3>
          <p>You don't have any scheduled appointments. Book one now to get started!</p>

          <!-- How It Works Section -->
          <div class="how-it-works">
            <h4>How MyQueue Works:</h4>
            <div class="steps-mini">
              <div class="mini-step">
                <span class="mini-number">1</span>
                <span class="mini-text">Book appointment</span>
              </div>
              <ion-icon name="arrow-forward" class="mini-arrow"></ion-icon>
              <div class="mini-step">
                <span class="mini-number">2</span>
                <span class="mini-text">Check-in via QR</span>
              </div>
              <ion-icon name="arrow-forward" class="mini-arrow"></ion-icon>
              <div class="mini-step">
                <span class="mini-number">3</span>
                <span class="mini-text">Track your queue</span>
              </div>
            </div>
          </div>

          <ion-button expand="block" size="large" (click)="bookAppointment()" class="cta-button">
            <ion-icon name="calendar" slot="start"></ion-icon>
            Book Appointment
          </ion-button>
        </div>
      </div>

    </div>

    <!-- ============================================ STATE B: HAS ACTIVE QUEUE (Already Checked In) ============================================ -->
    <div *ngIf="hasActiveQueue" class="active-queue-state">

      <ion-card class="queue-status-card">
        <ion-card-header>
          <div class="card-header-content">
            <div class="header-title-section">
              <ion-icon name="hourglass-outline"></ion-icon>
              <ion-card-title>Your Queue Status</ion-card-title>
            </div>
            <ion-button fill="clear" size="small" class="refresh-btn" (click)="refreshQueue()">
              <ion-icon slot="icon-only" name="refresh-outline"></ion-icon>
            </ion-button>
          </div>
        </ion-card-header>

        <ion-card-content>

          <div class="queue-number-section">
            <p class="label">Your Queue Number</p>
            <div class="queue-number-display">
              <h1 class="queue-number">{{ userQueueNumber }}</h1>
            </div>
            <ion-badge [color]="getQueueStatusColor()" class="status-badge">
              {{ getQueueStatusText() }}
            </ion-badge>
          </div>

          <div class="status-divider">
            <span></span>
            <ion-icon name="swap-vertical-outline"></ion-icon>
            <span></span>
          </div>

          <div class="serving-section">
            <p class="label">Currently Serving</p>
            <div class="serving-display">
              <ion-icon name="person-outline"></ion-icon>
              <h2 class="serving-number">{{ currentServingNumber }}</h2>
            </div>
          </div>

          <div class="info-grid">
            <div class="info-item people-info">
              <div class="info-icon">
                <ion-icon name="people-outline"></ion-icon>
              </div>
              <div class="info-text">
                <p class="info-value">{{ peopleAhead }}</p>
                <p class="info-label">People ahead</p>
              </div>
            </div>

            <div class="info-item time-info">
              <div class="info-icon">
                <ion-icon name="time-outline"></ion-icon>
              </div>
              <div class="info-text">
                <p class="info-value">~{{ estimatedWaitTime }} min</p>
                <p class="info-label">Estimated wait</p>
              </div>
            </div>
          </div>

          <!-- View Full Queue Status Button -->
          <ion-button expand="block" fill="solid" class="view-queue-btn" (click)="viewFullQueueStatus()">
            <ion-icon name="list" slot="start"></ion-icon>
            View Full Queue Status
          </ion-button>

        </ion-card-content>
      </ion-card>

      <div class="quick-actions-section">
        <div class="section-header compact">
          <h3>Quick Actions</h3>
        </div>

        <div class="quick-actions">
          <ion-button expand="block" fill="outline" class="quick-action-btn" (click)="bookAppointment()">
            <ion-icon slot="start" name="calendar-outline"></ion-icon>
            Book New Appointment
          </ion-button>

          <ion-button expand="block" fill="clear" class="quick-action-btn btn-secondary" (click)="viewAppointments()">
            <ion-icon slot="start" name="list-outline"></ion-icon>
            View All Appointments
          </ion-button>
        </div>
      </div>

    </div>

    <!-- Logout Confirmation Modal -->
    <div class="logout-overlay" *ngIf="showLogoutConfirm" (click)="showLogoutConfirm = false">
      <div class="logout-modal" (click)="$event.stopPropagation()">

        <div class="logout-icon-wrapper">
          <div class="logout-icon">
            <ion-icon name="log-out-outline"></ion-icon>
          </div>
        </div>

        <div class="logout-content">
          <h2 class="logout-title">Logout</h2>
          <p class="logout-message">Are you sure you want to logout?</p>
        </div>

        <div class="logout-actions">
          <ion-button expand="block" fill="outline" class="cancel-btn" (click)="showLogoutConfirm = false">
            Cancel
          </ion-button>
          <ion-button expand="block" color="danger" class="confirm-btn" (click)="confirmLogout()">
            <ion-icon slot="start" name="log-out"></ion-icon>
            Yes, Logout
          </ion-button>
        </div>

      </div>
    </div>

  </div>
</ion-content>